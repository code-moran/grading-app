"use strict";(()=>{var e={};e.id=5491,e.ids=[5491],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},60195:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>x,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>y});var s={};r.r(s),r.d(s,{GET:()=>GET,POST:()=>POST});var a=r(10884),d=r(16132),i=r(95798),n=r(94020),o=r(8192),l=r(15204);async function createAuditLog(e){try{let t=await l._.assessmentAuditLog.create({data:{gradeId:e.gradeId,action:e.action,performedBy:e.performedBy,performedByRole:e.performedByRole,previousValue:e.previousValue||null,newValue:e.newValue||null,notes:e.notes||null,ipAddress:e.ipAddress||null,userAgent:e.userAgent||null}});return t}catch(e){return console.error("Error creating audit log:",e),null}}async function GET(e){try{let{searchParams:t}=new URL(e.url),r=t.get("lessonId"),s=t.get("studentId"),a=t.get("exerciseId"),d={};r&&(d.lessonId=r),s&&(d.studentId=s),a&&(d.exerciseId=a);let n=await l._.grade.findMany({where:d,include:{student:!0,lesson:!0,exercise:!0,gradeCriteria:{include:{criteria:!0,level:!0}}},orderBy:{gradedAt:"desc"}}),o=n.map(e=>({id:e.id,studentId:e.studentId,lessonId:e.lessonId,exerciseId:e.exerciseId,criteriaGrades:e.gradeCriteria.map(e=>({criteriaId:e.criteriaId,levelId:e.levelId,points:e.points,comments:e.comments||"",criteriaName:e.criteria?.name,levelName:e.level?.name})),totalPoints:e.totalPoints,maxPossiblePoints:e.maxPossiblePoints,percentage:e.percentage,letterGrade:e.letterGrade,isCompetent:e.isCompetent,competencyStatus:e.competencyStatus,assessorId:e.assessorId,verifiedBy:e.verifiedBy,verifiedAt:e.verifiedAt,moderatedBy:e.moderatedBy,moderatedAt:e.moderatedAt,feedback:e.feedback,gradedBy:e.gradedBy,gradedAt:e.gradedAt,lesson:e.lesson?{id:e.lesson.id,number:e.lesson.number,title:e.lesson.title,courseId:e.lesson.courseId}:null,exercise:e.exercise?{id:e.exercise.id,title:e.exercise.title}:null}));return i.Z.json({grades:o})}catch(e){return console.error("Error fetching grades:",e),i.Z.json({error:"Failed to fetch grades"},{status:500})}}async function POST(e){try{let t=await (0,n.getServerSession)(o.L);if(!t?.user)return i.Z.json({error:"Unauthorized"},{status:401});let r=await e.json(),{studentId:s,lessonId:a,exerciseId:d,criteriaGrades:u,totalPoints:c,maxPossiblePoints:p,percentage:m,letterGrade:g,feedback:y,gradedBy:x,isCompetent:I,competencyStatus:f,assessorId:v,verifiedBy:w,moderatedBy:A}=r;if(!s||!a||!d||void 0===c||void 0===m||!g)return i.Z.json({error:"Missing required fields"},{status:400});let P=f,B=I;void 0===P&&(m>=70?(P="competent",B=!0):(P=m>=50?"needs_improvement":"not_competent",B=!1));let q=v;if(!q&&"instructor"===t.user.role){let e=await l._.instructor.findUnique({where:{userId:t.user.id},select:{id:!0}});q=e?.id||null}let b=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",h=e.headers.get("user-agent")||"unknown",_=await l._.$transaction(async e=>{let t;let r=await e.grade.findUnique({where:{studentId_exerciseId:{studentId:s,exerciseId:d}}}),i=r?{totalPoints:r.totalPoints,percentage:r.percentage,letterGrade:r.letterGrade,competencyStatus:r.competencyStatus,isCompetent:r.isCompetent}:null;return t=r?await e.grade.update({where:{id:r.id},data:{totalPoints:c,maxPossiblePoints:p||r.maxPossiblePoints,percentage:m,letterGrade:g,isCompetent:B,competencyStatus:P,assessorId:q||null,verifiedBy:w||null,verifiedAt:w?new Date:null,moderatedBy:A||null,moderatedAt:A?new Date:null,feedback:y||null,gradedBy:x||"Instructor",gradedAt:new Date}}):await e.grade.create({data:{studentId:s,lessonId:a,exerciseId:d,totalPoints:c,maxPossiblePoints:p||c,percentage:m,letterGrade:g,isCompetent:B,competencyStatus:P,assessorId:q||null,verifiedBy:w||null,verifiedAt:w?new Date:null,moderatedBy:A||null,moderatedAt:A?new Date:null,feedback:y||null,gradedBy:x||"Instructor"}}),await e.gradeCriteria.deleteMany({where:{gradeId:t.id}}),u&&Array.isArray(u)&&await e.gradeCriteria.createMany({data:u.map(e=>({gradeId:t.id,criteriaId:e.criteriaId,levelId:e.levelId,points:e.points,comments:e.comments||null}))}),{grade:t,previousValue:i}}),{grade:C,previousValue:S}=_,G=t.user.role,j=S?"updated":"assessed";await createAuditLog({gradeId:C.id,action:j,performedBy:t.user.id,performedByRole:"admin"===G?"admin":"instructor"===G?"assessor":"instructor",previousValue:S,newValue:{totalPoints:C.totalPoints,percentage:C.percentage,letterGrade:C.letterGrade,competencyStatus:C.competencyStatus,isCompetent:C.isCompetent},ipAddress:b,userAgent:h});let k={id:C.id,studentId:C.studentId,lessonId:C.lessonId,exerciseId:C.exerciseId,criteriaGrades:u||[],totalPoints:C.totalPoints,maxPossiblePoints:C.maxPossiblePoints,percentage:C.percentage,letterGrade:C.letterGrade,isCompetent:C.isCompetent,competencyStatus:C.competencyStatus,assessorId:C.assessorId,verifiedBy:C.verifiedBy,verifiedAt:C.verifiedAt,moderatedBy:C.moderatedBy,moderatedAt:C.moderatedAt,feedback:C.feedback,gradedBy:C.gradedBy,gradedAt:C.gradedAt};return i.Z.json({grade:k},{status:201})}catch(e){return console.error("Error creating grade:",e),i.Z.json({error:"Failed to create grade"},{status:500})}}let u=new a.AppRouteRouteModule({definition:{kind:d.x.APP_ROUTE,page:"/api/grades/route",pathname:"/api/grades",filename:"route",bundlePath:"app/api/grades/route"},resolvedPagePath:"C:\\Users\\admin\\projects\\grading-app\\app\\api\\grades\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:m,headerHooks:g,staticGenerationBailout:y}=u,x="/api/grades/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[657,8557,5798,7391,5226,8192],()=>__webpack_exec__(60195));module.exports=r})();